---
title: "Hill_postulae"
author: "Michael Roswell, Mark Genung, Tina Harrison"
date: "2/14/2022"
output: 
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Overview
Some of what makes one Hill diversity at on value of $\ell$ more predictive of
function than at another is about biology, other parts are about math. This is a
live document to record some quantitative relationships (both formal and
informal) about Hill diversity that may lead to clearer interpretations of
empirical findings.

## Hill number definition

We define Hill diversity $D$ as the mean species rarity in the assemblage

$$D=\left( \sum_{i=1}^{S}p_{i}(r_{i})^{\ell} \right)^{1/\ell} \tag{1}$$

where $D$ is diversity or mean rarity, $p_{i}$ is the relative abundance of
species $i$, $r_{i}$ is the rarity of species $i$ (defined as the reciprocal of
$p_{i}$), $S$ is the total species richness, and $\ell$ is the scaling exponent
that determines the type of mean computed [@Roswell2021]. 

Hill diversity is more commonly written as

$$D=\left( \sum_{i=1}^{S}p_{i}^{q} \right)^{1/1-q} \tag{2}$$
When $\ell = 0$ ($q = 1$), these equations are defined by their limit.

Equations 1 and 2 are equivalent when $\ell = 1-q$.

## Ranges of Hill numbers (assuming perfect observation)

For a given combination of $S$, $N$ (i.e. number of individuals), and $\ell$, 
there is a range of values that $D$ can possibly take. When $\ell$ is large, 
this range is also large, and when it is a large negative number, the range is 
much smaller, when $\ell = 1$ this range is at its minimum, $D=S$, for any $N$,
distribution of relative abundance.

For $\ell \geq 1$, the minimum value $D$ can take is $S$ (maximum evenness). As
$\ell \rightarrow \infty$, the maximum value of $D$ grows to the maximum species
rarity, i.e. $N$. When $1 \leq \ell < \infty$, $D$ reaches its maximum with
maximum dominance, but as $\ell \rightarrow \infty$ the maximum rarity drives
$D$ regardless of the shape of the species abundance distribution.

For $\ell <1$, the *maximum* value $D$ can take is $S$ (maximum evenness). As
$\ell \rightarrow -\infty$, the minimum value of $D$ shrinks to the minimum
species rarity, i.e. something nearing $1$ when $N >> S$ (maximum dominance).

## D-flipping

For a given $S$, $N$, the spearman rank correlation between the Hill diversity
of a set of assemblages when $\ell = \infty$ and when $\ell = -\infty$ is $-1$.
More simply, the even assemblage has maximum diversity for $\ell<1$ and minimum
diversity when $\ell>1$.

## Variable abundances

### High $\ell$

Assume data for many communities of variable SADs and abundance. In a given
community or sample, there is a minimum possible abundance for any one
species... this is less a biological point than a sampling one... in count data
you can't have less than one individual; in continuous abundance data (e.g.
cover), there will still be a minimum threshold at which species aren't
included, detected, or recorded.

As $\ell \rightarrow \infty$, $D$ approaches $N/min(n)$, where $n$ is the vector
of species abundances (and $N$ is the sum of that vector). In most cases, this
means $D$ is tightly correlated with $N$ for high values of $\ell$, as $min(n)$
likely varies little across communities [or samples] and is likely not strongly
related to abundance.

It is possible for $cor(log(D_{\ell \rightarrow \infty}), log(N))$ to be
negative, but it is unlikely to occur in natural, diverse communities which
nearly always have very rare species and vagrants at the minimum possible
abundance. However, this situation could occur in experiments or in very simple
systems with high abundance (we've imagined *Daphnia* in a lake). Namely, for
this to occur, $min(n)$ must monotonically increase with $N$, and
$sd(log(min(n))) > sd(log(N))$. This should be fairly clear re-arranging the
equation for correlation:


$cor(X,Y) = \frac{E(X*Y)-mean(X)*mean(Y)}{sd(X)*sd(Y)}$

Recalling that $D_{\ell \rightarrow \infty} = N/min(n)$, naming $min(n) = b$, and using
law of logs to do a bit of re-arranging, we have:


$cor(log(D), log(N)) = \frac{E[log(N)^2 - log(N)*log(b)] - [mean(log(N))^2 - mean(log(N))*mean(log(b))]} {sd(log(N)*sd(log(b))}$


The upshot of this is that (on the log-log scale), high-$\ell$ diversity is
nearly always strongly, positively correlated with total abundance. The possible 
exceptions are when there is big variability in minimum abundance relative to
the variability in total abundance. Without a monotonic positive relationship
between minimum and total abundance, this can weaken the correlation, and with
that relationship, it can be negative.

### Large negative $\ell$

### Inverse dominance and abundance
The relationship between abundance and Hill diversity for large negative $\ell$
values (converging on inverse dominance at the limit) can be positive, negative,
or non-existent, and tends not to be very strong. Because the maximum value of
inverse dominance is set by richness, and not by abundance *per se* (as it is
for large positive $\ell$ values), it makes intuitive sense that the
relationship between abundance and diversity would be weaker for large negative 
$\ell$ values than for large positive ones. 

In at least some empirical datasets we see a tendency towards a negative 
relationship between inverse dominance and abundance. This means that in larger 
communities, the degree of dominance is higher, which may be a result of highly
abundance species being able to take advantage of productive habitats (i.e. have 
high intrinsic growth rates). 



## Interpretations

When $\ell \rightarrow \infty$, $D$ conveys information primarily about
*abundance*. For our empirical data, we expect these Hill diversities to be
highly, positively predictive of function because function tends to increase
with abundance (and for our functions, adding one individual can only increase,
and not decrease, total function).

When $\ell \rightarrow -\infty$, $D$ conveys information primarily about
*dominance* (but not really evenness, which is complicated). The relationship 
between large negative $\ell$ diversities and function is often weak but highly
variable, and can be positive, negative, or essentially non-existent.

When the predictive ability of $D$ is maximized when $\ell \neq (-\infty, 1,
\infty)$ it is hard to say what aspects of the SAD are most salient. We need to 
develop our thinking here a bit more, since this seems to happen sometimes in 
empirical (and simulated) data and it's not only about abundance. It seems 
possible, also, that the high correlations at or very near richness are a deep
ecological or perhaps numerical thing that we definitely want to discuss.

```{r scratchpad}

# saved some of the fiddling

y <- c(1, 2, 3)
x <- c(10, 20, 31)
(mean(log(x)^2-log(x)*log(y))-
((mean(log(x)))^2-mean(log(x))*mean(log(y)))) /
(sd(log(x))*sd(log(x/y)))


x <- c(11, 20, 30)

(mean(log(x)^2-log(x)*log(y))-
((mean(log(x)))^2-mean(log(x))*mean(log(y)))) /
(sd(log(x))*sd(log(x/y)))

x <- c(10, 20, 29)

(mean(log(x)^2-log(x)*log(y))-
((mean(log(x)))^2-mean(log(x))*mean(log(y)))) /
(sd(log(x))*sd(log(x/y)))

mean(x-y)
mean(x) - mean(y)

mean(x) * mean(y)
mean(x*y)
mean(x)^2
mean(x^2)

y <- rnorm(100, 5, 1)
x <- rnorm( 100, 50, 4)
x <- rnbinom(100, mu = 2000, size = 2)
y <- rnbinom(100, mu = 1000*x^-1.1, size = 0.01) +1

y <- sapply(7-round(log(x^1.5, 10)), function(x){max(x,1)})  # rbinom(100, size = 1, prob = x^-0.5 ) + 1
y <- rnbinom(100, mu = 0.2, size = 1-x^-0.03) +1


x <- c(11, 20, 30)
y <- c(1, 2, 3)


x1 <- (rnbinom(3, mu = 1800, size = 5))
x <- x1[order(x1)]
y1 <- rnbinom(3, mu = 23, size = 0.1) 
y2 <- sapply(y1, function(x){max(x,1)})
y <- y2[order(y2)]

x-mean(x)
y-mean(y)
sd(x)
sd(y)
log(x)-mean(log(x))
log(y)-mean(log(y))
sd(log(x))
sd(log(y))

x<- x1
y <- y2

(mean(x*(x/y))-mean(x)*mean(x/y))/
  (sd(x)*sd(x/y))


(mean(log(x)^2-log(x)*log(y))-
((mean(log(x)))^2-mean(log(x))*mean(log(y)))) /
  (sd(log(x))*sd(log(x/y)))



```





