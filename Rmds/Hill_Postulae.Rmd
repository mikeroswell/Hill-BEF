---
title: "Hill_postulae"
author: "Michael Roswell, Mark Genung, Tina Harrison"
date: "7/04/2022"
output:
  word_document: default
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(MeanRarity)
```

## Overview
Some of what makes one Hill diversity at on value of $\ell$ more predictive of
function than at another is about biology, other parts are about math. This is a
live document to record some quantitative relationships (both formal and
informal) about Hill diversity that may lead to clearer interpretations of
empirical findings.

## Hill number definition

We define Hill diversity $D$ as the mean species rarity in the assemblage

$$D=\left( \sum_{i=1}^{S}p_{i}(r_{i})^{\ell} \right)^{1/\ell} \tag{1}$$

where $D$ is diversity or mean rarity, $p_{i}$ is the relative abundance of
species $i$, $r_{i}$ is the rarity of species $i$ (defined as the reciprocal of
$p_{i}$), $S$ is the total species richness, and $\ell$ is the scaling exponent
that determines the type of mean computed [@Roswell2021]. 

Hill diversity is more commonly written as

$$D=\left( \sum_{i=1}^{S}p_{i}^{q} \right)^{1/1-q} \tag{2}$$
When $\ell = 0$ ($q = 1$), these equations are defined by their limit.

Equations 1 and 2 are equivalent when $\ell = 1-q$.

## Ranges of Hill numbers (assuming perfect observation)

For a given combination of $S$, $N$ (i.e. number of individuals), and $\ell$,
there is a range of values that $D$ can possibly take. When $\ell = 1$ this
range is at its minimum, $D=S$, for any $N$, distribution of relative abundance.

For $\ell \geq 1$, the minimum value $D$ can take is $S$ (maximum evenness). As
$\ell \rightarrow \infty$, the maximum value of $D$ grows to the maximum species
rarity, i.e. $N$. When $1 \leq \ell < \infty$, $D$ reaches its maximum with
uneven communities, but as $\ell \rightarrow \infty$, only the rarest species
and abundance (i.e., the maximum rarity) drives $D$ regardless of the shape of
the species abundance distribution.

For $\ell <1$, the *maximum* value $D$ can take is $S$ (maximum evenness). As
$\ell \rightarrow -\infty$, the minimum value of $D$ shrinks to the minimum
species rarity, i.e. something nearing $1$ when $N >> S$ (maximum dominance).

## Diversity rankings across the $\ell$ spectrum and evenness.

The even assemblage has maximum diversity for $\ell<1$ and minimum diversity
when $\ell>1$. Because other considerations matter as well, this does not simply
mean that the rank order of assemblages' diversities necessarily flips between
large positive and negative $\ell$ (and they can change many times and at many
values of $\ell$; Hill diversity profiles can cross at least three times). By
many definitions of evenness (i.e., those that consider evenness a ratio of one
Hill diversity to richness, or a transformation thereof, see Chao and Ricotta),
it is a simple tautology that evenness is positively related to diversity for
$\ell<1$, negatively related to $\ell>1$, and *unrelated* to richness itself
(though sampling realities make this last point particularly unlikely).

To put this in terms used elsewhere in the literature (e.g. Patil and Taillie
1982 citing Dalton 1920's principle of transfers), For all $\ell$, transferring
abundance from a species with abundance >1 to a new species (i.e. one with 0
abundance) increases diversity. However, when $\ell>1$, transferring abundance
from a species with abundance >1 to another species with positive, but lesser
abundance (this could be said more sharply) leads to a decrease in diversity,
where, by the "principle of transfers" one might expect the opposite; this is
guaranteed by $\ell \leq 1$.


## Variable abundances

### Large positive $\ell$

Assume data for many communities of variable SADs and abundance. In a given
community or sample, there is a minimum possible abundance for any one
species... this is less a biological point than a sampling one... in count data
you can't have less than one individual; in continuous abundance data (e.g.
cover), there will still be a minimum threshold at which species aren't
included, detected, or recorded.

As $\ell \rightarrow \infty$, $D$ approaches $N/min(n)$, where $n$ is the vector
of species abundances (and $N$ is the sum of that vector). In most cases, this
means $D$ is tightly correlated with $N$ for high values of $\ell$, as $min(n)$
likely varies little across communities [or samples] and is likely not strongly
related to abundance.

It is possible for $cor(log(D_{\ell \rightarrow \infty}), log(N))$ to be
negative, but it is unlikely to occur in natural, diverse communities which
nearly always have very rare species and vagrants at the minimum possible
abundance. However, this situation could occur in experiments or in very simple
systems with high abundance (we've imagined *Daphnia* in a lake). Namely, for
this to occur, $min(n)$ must monotonically increase with $N$, and
$sd(log(min(n))) > sd(log(N))$. This should be fairly clear re-arranging the
equation for correlation:


$cor(X,Y) = \frac{E(X*Y)-mean(X)*mean(Y)}{sd(X)*sd(Y)}$

Recalling that $D_{\ell \rightarrow \infty} = N/min(n)$, naming $min(n) = b$, and using
law of logs to do a bit of re-arranging, we have:


$cor(log(D), log(N)) = \frac{E[log(N)^2 - log(N)*log(b)] - [mean(log(N))^2 - mean(log(N))*mean(log(b))]} {sd(log(N)*sd(log(b))}$


The upshot of this is that (on the log-log scale), high-$\ell$ diversity is
nearly always strongly, positively correlated with total abundance. The possible 
exceptions are when there is big variability in minimum abundance relative to
the variability in total abundance. Without a monotonic positive relationship
between minimum and total abundance, this can weaken the correlation, and with
that relationship, it can be negative.

### Large negative $\ell$

The relationship between abundance and Hill diversity for large negative $\ell$
values (converging on inverse dominance at the limit) can be positive, negative,
or non-existent, and tends not to be very strong. Because the maximum value of
inverse dominance is set by richness, and not by abundance *per se* (as it is
for diversity at large positive $\ell$ values), it makes intuitive sense that
the relationship between abundance and diversity would be weaker for large
negative $\ell$ values than for large positive ones.

In at least some empirical datasets, we see a tendency towards a negative
relationship between inverse dominance and abundance. This means that in more
abundant assemblages, the degree of dominance is higher, which may be a result
of highly abundance species being able to take advantage of productive habitats
(i.e. have high intrinsic growth rates).

### $\ell$ near 1
Even with big variation around larger magnitude values of $\ell$, diversity
changes little, because when the magnitude of $\ell$ is large, diversity is
likely close to its asymptotic value, and largely sensitive to only two values
($N$ and either $max(n)$ or $min(n)$ (CITE May 1975 from Cody and Diamond)).
However, at intermediate $\ell$ values (not sure exactly what this means but
something in the realm of $-0.5 < \ell <1.5$), Diversity is more sensitive to
the full distribution of relative abundances, and, of course, to richness *per
se*.

In curves (relating $\ell$ on the x to the correlation between abundance and
diversity on the y), the ends have to be pretty flat (because diversity
converges on its left and right asymptotes when the magnitude of $\ell$ is
large)... but if there is going to be one or more peaks, they must occur near
the less constrained middle of the curve. In curves  plotted from simulated and
empirical data, we see peaks and valleys off the other wise smooth step-up along
the transition from negative to positive $\ell$. We know to expect change in the
vicinity of $\ell = 1$, but more details, such as the $\ell$ values of
inflection points and peaks, or the cause of very smooth vs. more complex
shapes, remain a bit mysterious.

## Notes on $\ell >1$

It has been traditional within the diversity literature to ignore diversities
with $\ell >1$. This is a list of the reasons cited for this, along with some
notes.

Patil and Taillie 1982 J. Am. Stat. Ass. state in section 4 that diversity
measures should obey a "principle of transfers" (Dalton 1920 The Economic
Journal); that is, transferring abundance from more to less abundant species
(where less abundant species could have abundance ≥0) should not decrease
diversity. This obviously does not hold for $\ell >1$. This seems legitimate;
q for us why it is useful to consider Hill numbers when this property doesn't hold.

Leinster and Cobbold 2012 Ecology define $0^0$ as 1 and then note that $0^q$ is
not defined for $q<0$. This seems like a trivial concern but maybe we need to
worry about 0-abundance species for lots of diversity generalizations that
aren't just about a single assemblage.

Chao et al. 2014 Ecological Monographs note that for $q<0 = |ell>1$, Hill 
diversity estimation is wickedly difficult b/c of the sampling properties of 
rarity. While the idea that rare species pose a difficulty for estimation is 
obviously valid and one of my favorite, it seems strange to impose a cutoff at 
richness (why not something more Hill-Shannon-like, c.f. Haegeman et al. 2013?). 
They also cite Ricotta 2003 as claiming that if two communities had the same 
relative abundance, the one with greater absolute diversity should be considered 
more diverse. The Ricotta paper suggests focusing on "total information" rather
than average information by multiplying a scaled total abundance measure by a 
scaled entropy. It doesn't look like people loved the idea as this paper has 
seldom been cited. 


## math reminder: fractional exponents
$x^{ab}=(x^a)^b$
This means that 
$x^\frac{p,q}$ implies a number $a$ such that $a^q = x^p$
So $x^1.5$ is like saying what is $a$ s.t. $a^2 = x^3$ i.e. $\sqrt{x^3}$
This doesn't seem like a crazy number to think about.

## Interpretations

When $\ell \rightarrow \infty$, $D$ is (usually) driven almost entirely by
*abundance*. For our empirical data, we also expect high-$\ell$ Hill diversities
to be highly, positively predictive of function because function tends to
increase with abundance (and for our functions, adding one individual can only
increase, and not decrease, total function).

When $\ell \rightarrow -\infty$, $D$ conveys information primarily about
*dominance* (but not really evenness, which is complicated). The relationship 
between large negative $\ell$ diversities and function is often weak but highly
variable, and can be positive, negative, or essentially non-existent.

When the predictive ability of $D$ is maximized when $\ell \notin (-\infty, 1,
\infty)$ it is hard to say what aspects of the SAD are most salient. We need to
develop our thinking here a bit more, since this seems to happen sometimes in
empirical (and simulated) data and it's not only about abundance, inverse
dominance, or richness alone.



## Sampling issues with diversity

### bias
In all samples from a larger assemblage, sample Hill diversities are substantially
below their true assemblage-level values. This is increasingly true with smaller
samples, less evenness, and higher $\ell$. Because the naïve, sample diversity
is a strongly downward-biased estimate of true diversity, there exist many
reduced-bias estimators, at least up to richness; for $\ell<<1$ these may have
little and/or positive bias (e.g. inverting E.H. Simpson's unbiased estimator of
the Simpson's concentration produces Hill-Simpson diversity estimates with a
positive bias). While the bias in estimating the rarity of the most common
species is relatively small (Chao and Jost 2012, 2015), because the relative
abundance of undetected species tends to be substantial, the relative abundance
of even the most common species is, nevertheless, typically underestimated,
explaining why the sample Hill diversity as $\ell \rightarrow - \infty$ is still
lower than the true value in the full assemblage.

### variability

The proportional variability in the diversity of a sample decreases with $\ell$
and evenness. For larger positive values of $\ell$, there tends to be little
variability in diversity, given sample size, especially relative to the large
values diversity can take when $\ell>1$. 

## total error... side note
Further work remains here, but based on simulations from Roswell & Dushoff
unpublished MeanRarity MS, the proportional error of the naïve estimator (that
is, using sample diversity *per se* as an estimator of true diversity) grows
rapidly with $\ell$ at lower sample sizes.. but for better-sampled, more even
assemblages, the proportional error is greater near Hill-Shannon than near
Hill-Simpson or Richness.


## correlation facts

Correlation isn't all there is to say about the dependence of two variables. For
example, take $Y = 1/X$. There's actually not much we can say about the
correlation between $X$ and $Y$. At first this was not obvious to me, as
obviously, $Y$ always decreases in magnitude when $X$ increases in magnitude and
vice-versa. The correlation, though, could be strong or weak, and signed either
way, depending on the distribution of X).

```{r there is no correlation with inversion}
SS <- 100
its <- 999
rpois_30 <-function(x){rpois(x, 30)}
icor <- map_dfr(1:its, function(it){
  map_dfr(c("runif", "rnorm", "rpois_30"), function(dist){
  x <- get(dist)(SS)
  y <- 1/x
  return(data.frame(icor = cor(x,y)
                    , dist ))
  })
})
icor %>% ggplot(aes(icor, color = dist)) + 
  geom_histogram() +
  xlim(c(-1,1))+
  labs(title = "correlation of X with its inverse", x = "correlation") +
  theme_classic()

```

It is tempting to imagine that if we know the relationship between
abundance and diversity and the relationship between per-capita function then
we know the relationship between diversity and total function. But when it comes
to correlations, this isn't true. 

Knowing $\rho(X, W)$ and $\rho(Y,W)$ doesn't give much information about
$\rho(Z,W), Z = XY$. Maybe under very strict conditions about the distributions
of $X, Y, W$ we could say more. But especially if $cov(X,Y)\neq 0$, at the level
of correlations, saying general things about the $cor(Z,W)$ based on $cor(X,W)$
and $cor(Y,W)$ is basically impossible.

Oh, this might be a useful [link](https://stats.stackexchange.com/a/318653/171222)

```{r scratchpad, echo = FALSE, include = FALSE }

# saved some of the fiddling

y <- c(1, 2, 3)
x <- c(10, 20, 31)
(mean(log(x)^2-log(x)*log(y))-
((mean(log(x)))^2-mean(log(x))*mean(log(y)))) /
(sd(log(x))*sd(log(x/y)))


x <- c(11, 20, 30)

(mean(log(x)^2-log(x)*log(y))-
((mean(log(x)))^2-mean(log(x))*mean(log(y)))) /
(sd(log(x))*sd(log(x/y)))

x <- c(10, 20, 29)

(mean(log(x)^2-log(x)*log(y))-
((mean(log(x)))^2-mean(log(x))*mean(log(y)))) /
(sd(log(x))*sd(log(x/y)))

mean(x-y)
mean(x) - mean(y)

mean(x) * mean(y)
mean(x*y)
mean(x)^2
mean(x^2)

y <- rnorm(100, 5, 1)
x <- rnorm( 100, 50, 4)
x <- rnbinom(100, mu = 2000, size = 2)
y <- rnbinom(100, mu = 1000*x^-1.1, size = 0.01) +1

y <- sapply(7-round(log(x^1.5, 10)), function(x){max(x,1)})  # rbinom(100, size = 1, prob = x^-0.5 ) + 1
y <- rnbinom(100, mu = 0.2, size = 1-x^-0.03) +1


x <- c(11, 20, 30)
y <- c(1, 2, 3)


x1 <- (rnbinom(3, mu = 1800, size = 5))
x <- x1[order(x1)]
y1 <- rnbinom(3, mu = 23, size = 0.1) 
y2 <- sapply(y1, function(x){max(x,1)})
y <- y2[order(y2)]

x-mean(x)
y-mean(y)
sd(x)
sd(y)
log(x)-mean(log(x))
log(y)-mean(log(y))
sd(log(x))
sd(log(y))

x<- x1
y <- y2

(mean(x*(x/y))-mean(x)*mean(x/y))/
  (sd(x)*sd(x/y))


(mean(log(x)^2-log(x)*log(y))-
((mean(log(x)))^2-mean(log(x))*mean(log(y)))) /
  (sd(log(x))*sd(log(x/y)))



```





